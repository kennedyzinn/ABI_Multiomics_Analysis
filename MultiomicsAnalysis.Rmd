---
title: "Mulitomics Analysis"
author: "Kennedy Zinn"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: true
    theme: flatly
    code_folding: hide
geometry: "margin=0.2in"
header-includes:
  - \usepackage{pdfpages}
---

The following is my work guided by the questions of excercise #5. The code for this analysis is available at https://github.com/kennedyzinn/ABI_Multiomics_Analysis. The data analyzed and explored here is from DiBella et al. (2021), and is single cell RNA-seq and single cell ATAC-seq data collected from the mouse neocortex during embryonic development. Specifically, the scRNA-seq data is from time points E11.5 to E16.5 and scATAC-seq data was sampled at E18.5.

The Allen Brain Institute (ABI) online data portal encompasses many single cell resolution datasets, mainly ATAC-seq and RNA-seq data from the Central Nervous System (CNS) of mouse models, humans and primates. Some datasets include spatial transcriptomics data, including their transcriptomic spatial cell-type atlas, which has provided insights in characterizing cell-type specific differences in the ventral regions versus dorsal regions, and provided spatial and transcriptomic characterizations for different cell types.

The ABI also provides tools, including MapMayCells, which allows researchers to use the taxonomy of cell types in the mouse brain as a reference against their own data. The ABI also has electrophysiological and morphological data which can be combined with transcriptomic data to elucidate brain circuitry and neuronal function.

```{r, include = FALSE}
knitr::opts_chunk$set(warning = FALSE)
library(Seurat)
library(hdf5r)

rna_files <- list(
  "E11" = "E11_5_filtered_gene_bc_matrices_h5.h5", 
  "E12" = "E12_5_filtered_gene_bc_matrices_h5.h5", 
  "E13" = "E13_5_filtered_gene_bc_matrices_h5.h5", 
  "E14" = "E14_5_filtered_gene_bc_matrices_h5.h5", 
  "E15" = "E15_5_filtered_gene_bc_matrices_h5.h5", 
  "E16" = "E16_5_filtered_gene_bc_matrices_h5.h5")
rna_list <- lapply(rna_files, Read10X_h5)

E11_rna <- rna_list$E11
E12_rna <- rna_list$E12
E13_rna <- rna_list$E13
E14_rna <- rna_list$E14
E15_rna <- rna_list$E15
E16_rna <- rna_list$E16
```

# Repeated Measures Analysis

```{r, include = FALSE}
library(SingleR)
library(anndata)

E11_seurat <- CreateSeuratObject(E11_rna, project = "E11.5")
E12_seurat <- CreateSeuratObject(E12_rna, project = "E12.5")
E13_seurat <- CreateSeuratObject(E13_rna, project = "E13.5")
E14_seurat <- CreateSeuratObject(E14_rna, project = "E14.5")
E15_seurat <- CreateSeuratObject(E15_rna, project = "E15.5")
E16_seurat <- CreateSeuratObject(E16_rna, project = "E16.5")

combined <- merge(E11_seurat, y = c(E12_seurat, E13_seurat, E14_seurat, E15_seurat, E16_seurat),
                  add.cell.ids = c("E11.5", "E12.5", "E13.5", "E14.5", "E15.5", "E16.5"))
remove(list = ls(pattern = "^E"))
```

```{r, include=FALSE}
combined$mitoPercent <- PercentageFeatureSet(combined, pattern = "^mt-")
combined <- subset(combined, subset = nFeature_RNA > 200 & nFeature_RNA < 2500 &
                     nCount_RNA > 800 &
                     mitoPercent < 5)
```

Data pre-processing of the RNA data followed a standard scRNA-seq workflow. After standardizing the data, I completed clustering analysis by first employing Principal Component Analysis (PCA), followed by integrating the data from the six different time points, then running Uniform Manifold Approximation and Projection (UMAP), which further reduces the dimensionality of the data, while capturing relationships in the data that are more biologically plausible than linear relationships illustrated when using PCA alone. I finished clustering analysis by employing K-Nearest Neighbors (KNN), which separates the data into different clusters.

```{r, include = FALSE}
# preprocessing
combined <- NormalizeData(combined)
combined <- FindVariableFeatures(combined)
combined <- ScaleData(combined)
combined <- RunPCA(combined)

# integrate
library(harmony)
combined <- RunHarmony(combined, group.by.vars = "orig.ident")
combined <- RunUMAP(combined, reduction = "harmony", dims = 1:30)

# clustering using KNN
combined <- FindNeighbors(combined, reduction = "harmony", dims = 1:30)
combined <- FindClusters(combined, resolution = 0.1)
```

```{r, include = FALSE}
# get annotation
library(celldex)
ref <- MouseRNAseqData() 

# annotate
library(SingleCellExperiment)
combined <- JoinLayers(combined)
sce <- as.SingleCellExperiment(combined)

predictions <- SingleR(test = sce, ref = ref, labels = ref$label.fine)
combined$cell_type <- predictions$labels
remove(sce)
```

The first plot represents the clusters identified by UMAP. From these plots, we can see some clustering by cell type and time point. There is some overlap in time points and the clusters identified by PCA and UMAP, suggesting that other variables not recorded in this dataset contribute to cortical development (such as predetermined neuron type or function).

```{r}
# clusters found by UMAP and PCA
library(ggplot2)
p <- DimPlot(combined, reduction = "umap", label = TRUE) +
  ggtitle("Clusters Identified by UMAP")
p$layers[[1]]$aes_params$alpha <- 0.25
p

# by timepoint
p <- DimPlot(combined, reduction = "umap", group.by = "orig.ident", label = F) +
  ggtitle("Clustering by Time Point")
p$layers[[1]]$aes_params$alpha <- 0.25
p

# by cell type

p <- DimPlot(combined, reduction = "umap", group.by = "cell_type", label = F, repel = TRUE) +
  ggtitle("Clustering by Cell Type")
p$layers[[1]]$aes_params$alpha <- 0.25
p
```

Here we can see with certainty that the large majority of cell types is neurons, and the large majority of neurons are neural progenitor cells (NPCs).

```{r}
# Generate distinct colors
library(scales)
cell_types <- unique(combined$cell_type)
n_colors <- length(cell_types)
my_colors <- hue_pal()(n_colors) 

# Manually adjust colors for similar cell types
# Example: if "Neurons_1" and "Neurons_2" are too similar
names(my_colors) <- cell_types
my_colors["Neurons"] <- "#A020F0"  # Red
my_colors["NPCs"] <- "#377EB8"  # Blue
my_colors["OPCs"] <- "#E41A1C"   # Green
my_colors["aNSCs"] <- "#4DAF4A" # purple
p <- DimPlot(combined, reduction = "umap", group.by = "cell_type", cols = my_colors, label = F, repel = TRUE)
p$layers[[1]]$aes_params$alpha <- 0.5
p
```

```{r, include = FALSE}
library(dplyr)
# add corticogenic wave labels
combined$corticogenic_wave <- case_when(
  combined$orig.ident %in% c("E11.5", "E12.5", "E13.5") ~ "Deep Layers (VI, V)",
  combined$orig.ident %in% c("E14.5", "E15.5", "E16.5") ~ "Superficial Layers (II, III, IV)",
  TRUE ~ "Other"
)

# Or using base R:
combined$corticogenic_wave <- ifelse(
  combined$orig.ident %in% c("E11.5", "E12.5", "E13.5"),
  "Deep Layers (VI, V)",
    "Superficial Layers (II, III, IV)"
)
```

Cortical neurogenesis is a process during embryonic development, from E11 to E17, in which neural stem cells generate neurons that then migrate to form the neocortex (Levers et al., 2001). This process takes place in an 'inside-out' fashion, where the deepest layers of the cortex are formed first, and the most superficial layers are formed last. Below is a clustering analysis this time by using the canonical times the deep layer and superficial layers are formed (Di Bella et al., 2021; Ohte et al. (2025). We can see some distinguishable separations between the formation of the deep layers (V and VI) and the superficial layers (II, III, IV). Although not specified, separate datasets found in this lab's directory, labeled C and R at time points E10.5, suggest that this data here might not encompass the Cajal-Retzius cells that are formed early and form the first layer. However, given some overlap of the clusters, we cannot be certain.

```{r}
# UMAP by layer
p <- DimPlot(combined, 
        reduction = "umap", 
        group.by = "corticogenic_wave",
        cols = c("Deep Layers (VI, V)" = "#E41A1C",
                 "Superficial Layers (II, III, IV)" = "#377EB8")) +
  ggtitle("Deep vs Superficial Layers")
p$layers[[1]]$aes_params$alpha <- 0.25
p
```

# Temporal Analysis of Corticogenesis

## Differential Analysis of Neural Progenitor Cells

In further analysis, I aimed to explore the change of the NPCs across cortical neurogenesis, given that the available data encompasses almost the entire time period in which it is believed to take place. Differential analysis employs a contrast matrix on a simple model;

gene expression~i~ = time point~j~,

Which aims to predict the gene expression of gene (i) by the day (time point (j), where j = E11.5...E16.5) the NPC was sampled. By employing a contrast matrix, I compare gene expression from each day to the day prior, instead of only comparing each day to E11.5. This allows for a more granular illustration of gene expression changes across cortical development, and allows for comparisons across 'deep layer days' and 'superficial layer days'.

```{r, inlcude = FALSE}
# Compare consecutive timepoints to see temporal changes

# set identities to timepoints
combined$ct.time <- paste0(combined$cell_type, combined$orig.ident)

Idents(combined) <- "ct.time"

contrasts_list <- list(
  E12_vs_E11 = c("NPCsE12.5", "NPCsE11.5"),
  E13_vs_E12 = c("NPCsE13.5", "NPCsE12.5"),
  E14_vs_E13 = c("NPCsE14.5", "NPCsE13.5"),
  E15_vs_E14 = c("NPCsE15.5", "NPCsE14.5"),
  E16_vs_E15 = c("NPCsE16.5", "NPCsE15.5")
)

# Run all contrasts
contrast_results <- lapply(names(contrasts_list), function(contrast_name) {
  contrast <- contrasts_list[[contrast_name]]
  
  de_genes <- FindMarkers(combined,
                          ident.1 = contrast[1],
                          ident.2 = contrast[2],
                          min.pct = .1,
                          logfc.threshold = 0)
  
  de_genes$gene <- rownames(de_genes)
  de_genes$contrast <- contrast_name
  return(de_genes)
})

# Combine all results
all_contrasts <- do.call(rbind, contrast_results)

# Summary
contrast_summary <- all_contrasts %>%
  filter(p_val_adj < 0.05) %>%
  group_by(contrast) %>%
  summarise(
    n_up = sum(avg_log2FC > 0),
    n_down = sum(avg_log2FC < 0),
    total_de = n()
  )
```

```{r}
print(contrast_summary)
```

### Visualization of DEG Density

Below represents the density of differentially expressed genes (DEGs) compared to the day prior, using bar graphs and volcano plots. Dramatic changes occur from E12.5 to E14.5 in an alternating pattern between sudden increased expression of many genes to a sudden repression of gene expression. However, these graphs alone cannot determine if it is the same genes that undergo sudden expression and subsequent suppression. Further analysis could determine the proportion of shared expression changes, which could suggest if certain brief but important neurogenic processes have been captured by this dataset.

#### Bar plot of DEG Counts

```{r}
library(tidyr)
```

```{r}
# Summary of significant genes per contrast
de_summary <- all_contrasts %>%
  filter(p_val_adj < 0.05, abs(avg_log2FC) > 0.5) %>%
  group_by(contrast) %>%
  summarise(
    Upregulated = sum(avg_log2FC > 0),
    Downregulated = sum(avg_log2FC < 0)
  ) %>%
  pivot_longer(cols = c(Upregulated, Downregulated),
               names_to = "Direction",
               values_to = "Count")

# Order contrasts chronologically
de_summary$contrast <- factor(de_summary$contrast,
                              levels = c("E12_vs_E11", "E13_vs_E12", "E14_vs_E13", 
                                        "E15_vs_E14", "E16_vs_E15"))

ggplot(de_summary, aes(x = contrast, y = Count, fill = Direction)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = c("Upregulated" = "#E41A1C", "Downregulated" = "#377EB8")) +
  theme_minimal() +
  labs(title = "Number of Differentially Expressed Genes Per Timepoint Comparison",
       x = "Contrast",
       y = "Number of DE Genes") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

#### Volcano Plots

```{r}
library(patchwork)

# Create volcano plot for each contrast
names(contrast_results) <- names(contrasts_list)

volcano_plots <- lapply(names(contrast_results), function(contrast_name) {
  data <- contrast_results[[contrast_name]]
  data$significant <- ifelse(data$p_val_adj < 0.05 & abs(data$avg_log2FC) > 0.5, 
                             "Significant", "Not Significant")
  
  ggplot(data, aes(x = avg_log2FC, y = -log10(p_val_adj), color = significant)) +
    geom_point(alpha = 0.6, size = 1) +
    scale_color_manual(values = c("Not Significant" = "gray", "Significant" = "red")) +
    geom_vline(xintercept = c(-0.5, 0.5), linetype = "dashed", color = "blue") +
    geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "blue") +
    theme_minimal() +
    labs(title = contrast_name,
         x = "Log2 Fold Change",
         y = "-Log10 Adjusted P-value") +
    theme(legend.position = "bottom")
})

# Combine all volcano plots
volcano_plots[[1]] + volcano_plots[[2]] + volcano_plots[[3]] + 
  volcano_plots[[4]] + volcano_plots[[5]] + 
  plot_layout(ncol = 3)
```

# Gene Profile

Here I identify genes differentially expressed during early neurogenesis (E11.5 to E13.5) and late neurogenesis (E14.5 to E16.5); 'deep layer days' and 'superficial layer days', respectively. Further analysis could identify unique gene markers for each time point, from E12.5 to E16.5 in a similar fashion as done below.

First, I filtered the results from differential analysis for DEGs that are significant following multiple testing correction (FDR \< 0.05). For each time point, I chose the 30 DEGs with the greatest absolute log2 fold change.

```{r, include=FALSE}
# identify layer-specific DEGs
all_contrasts$cort_layer <- ifelse(grepl("^E12|^E13", all_contrasts$contrast),
                                 "deep",
                                 "superficial")
top30 <- all_contrasts %>% 
  filter(p_val_adj < 0.05) %>% 
  group_by(contrast) %>% 
  arrange(-abs(avg_log2FC), .by_group = T) %>% 
  slice_head(n = 30) %>% 
  ungroup
```

From there, I organized the data into deep layer time points (E11.5 to E13.5) and superficial layer time points (E14.5 to E16.5), ordered by absolute log2 fold change. Interestingly, Xist had the largest change in expression in both groups, largely because expression dipped on E13.5 and increased dramatically on E14.5.

Hoping to find DEGs specific to each groups, I narrowed the results by only genes uniquely found as a top DEG in the deep layer group, and similarly for the superficial layer group.

Below are the profiles of a select few genes from the list. Xist, which was the top DEG in both groups, Kcnn2, which is a top gene essential for action potentials, whose change in expression is unique to early neurogenesis, and Hbb-bs, a hemoglobin gene determined to change expression unique to late neurogenesis.

```{r}
deep_top <- top30[top30$cort_layer=="deep",] %>% 
  arrange(-abs(avg_log2FC))
deep_top
```

```{r}
sup_top <- top30[top30$cort_layer=="superficial",] %>% 
  arrange(-abs(avg_log2FC))
sup_top
```

```{r}
#DEGs unique to deep layer
deep_unique <- anti_join(deep_top, sup_top, by = "gene")
deep_unique
```

```{r}
sup_unique <- anti_join(sup_top, deep_top, by = "gene")
sup_unique
```

```{r}

library(dplyr)

plot_gene_by_time <- function(seurat_obj, gene, time_col = "orig.ident") {
  
  df <- FetchData(seurat_obj, vars = c(gene, time_col)) %>%
    group_by(.data[[time_col]]) %>%
    summarise(avg_expr = mean(.data[[gene]]), .groups = "drop")
  
  ggplot(df, aes_string(x = time_col, y = "avg_expr", group = 1)) +
    geom_line(size = 1, color = "steelblue") +
    geom_point(size = 3, color = "darkblue") +
    labs(
      title = paste("Average expression of", gene, "across time points"),
      x = "Time point",
      y = "Average expression"
    ) +
    theme_bw()
}
```

Xist is exclusively expressed on the inactive X chromosome and is essential for X-inactivation (NIH). This gene was the most differentially expressed in both groups, as its expression changed dramatically from E12.5 to E14.5.

```{r}
# plot Xist expression across neurogenesis
plot_gene_by_time(combined, "Xist")
```

Kcnn2 enables small conductance calcium-activate potassium channel activity. It is used for modulating chemical synaptic transmission and is active in glutamatergic synapses and postsynaptic membrane (NIH). This gene was a unique top DEG in early neurogensis. However, but unsurprisingly, the plot shows that expression increases throughout neurogenesis, peaking at E14.5 and leveling out after; the most significant increase in expression was detected in the early phases, from E11.5 to E12.5.

```{r}
plot_gene_by_time(combined, "Kcnn2")
```

Hbb-bs is a top unique DEG in the later phases of neurogenesis. Hbb-bs code for a polyeptide chain found in hemoglobin and is involved in transporting oxygen to peripheral tissues. Peaking in expression at E12.5 and dropping by E13.5, Hbb-bs expression gradually increases linearly from E13.5 to E16.5. Literature suggests that neuronal hemoglobin expression in mature neurons may play a role in neuronal epigenetics, metabolism and function (Brown et al., 2016, Richter et al., 2009).

Although expression peaks at E12.5, the bar graphs and volcano plots show that many genes increased expression dramatically; it may be that the increased expression of Hbb-bs on E12.5 was not dramatic relative to other genes at that time point.

```{r}
plot_gene_by_time(combined, "Hbb-bs")
```

The analysis of the scRNA-seq data here is preliminary at best; further analysis could include identifying markers unique to each time point, exploring which genes are continually changing throughout cortical neurogenesis (ie shared DEGs across time points), Gene Set Analysis (GSEA) to summarize the DEGs identified here, and a Weighted Gene Co-Expression Network Analysis (WGCNA), to identify the gene networks involved here and identify genes that act as key drivers during development.

# ATAC-Seq; Multiomics Integration

Full scATAC-seq data from only E18.5 was readily available for analysis. Here, I compare the open chromatin regions at E18.5 to gene expression at E16.5, with the goal of identifying genes which may regulate chromatin accessibility of marker genes on the genome. Considering the temporal difference in the datasets, associated chromatin regions are considered to be latent responses associated with gene expression.

```{r, include=FALSE}
library(Signac)
rm(list = setdiff(ls(), "combined"))
E18_atac <- Read10X_h5("E18_5_filtered_peak_bc_matrix.h5")
E18_frag_file <- "E18_atac_fragments.tsv.tar.download/E18_atac_fragments/E18_atac_fragments.tsv.gz"
```

```{r, include = FALSE}
# Get annotations from EnsDb
library(EnsDb.Mmusculus.v79)
annotations <- GetGRangesFromEnsDb(ensdb = EnsDb.Mmusculus.v79)

# Change to UCSC style
seqlevelsStyle(annotations) <- "UCSC"
genome(annotations) <- "mm10"
```

```{r, include=FALSE}
# Same for E18.5
E18_chromatin <- CreateChromatinAssay(
  counts = E18_atac,
  sep = c(":", "-"),
  fragments = E18_frag_file,
  genome = "mm10",
  min.cells = 10,
  min.features = 200,
  annotation = annotations
)

E18_seurat <- CreateSeuratObject(
  counts = E18_chromatin,
  assay = "ATAC",
  project = "E18.5_ATAC"
)
```

```{r, include=FALSE}
# processing
E18_seurat <- RunTFIDF(E18_seurat, assay = "ATAC")
E18_seurat <- FindTopFeatures(E18_seurat, min.cutoff = 'q0')
E18_seurat <- RunSVD(E18_seurat, assay = "ATAC")
E18_seurat <- RunUMAP(E18_seurat, reduction = "lsi", dims = 2:30)
E18_seurat <- FindNeighbors(E18_seurat, reduction = "lsi", dims = 2:30)
E18_seurat <- FindClusters(E18_seurat, resolution = 0.1, algorithm = 3)
```

Pre-processing of single cell ATAC-seq data followed a standard workflow. After standardizing, I completed cluster analysis using UMAP and KNN.

```{r}
# visualize
DimPlot(E18_seurat, reduction = "umap", label = F) + labs(title = "Clusters of ATAC-seq Data")
```

```{r, include=FALSE}
gene.activities <- GeneActivity(E18_seurat)

E18_seurat[['RNA']] <- CreateAssayObject(counts = gene.activities)
E18_seurat <- NormalizeData(object = E18_seurat,
              assay = 'RNA',
              normalization.method = 'LogNormalize',
              scale.factor = median(E18_seurat$nCount_RNA))

DefaultAssay(E18_seurat) <- 'RNA'
```

Below are plots of the data by genes considered to be canonical markers of E18.5, and their predicted gene expression given the accessibility of associated chromatin regions. Pax6 and Dcx display a particular enrichment of chromatin accessibility.

```{r}
FeaturePlot(E18_seurat, features = c('Pax6', 'Sox2', 'Nes', 'Dcx'), # canonical marker genes of progenitor neurons
            pt.size = 0.1,
            max.cutoff = 'q95',
            ncol = 2)
```

```{r, include=FALSE}
# Load the scRNA-seq data
E16_rna <- Read10X_h5("E16_5_filtered_gene_bc_matrices_h5.h5")
E16_rna <- CreateSeuratObject(E16_rna, project = "E16.5")

E16_rna$mitoPercent <- PercentageFeatureSet(E16_rna, pattern = "^mt-")
E16_rna <- subset(E16_rna, subset = nFeature_RNA > 200 & nFeature_RNA < 2500 &
                     nCount_RNA > 800 &
                     mitoPercent < 5)
```

```{r, include=FALSE}
# preprocessing
E16_rna <- NormalizeData(E16_rna)
E16_rna <- FindVariableFeatures(E16_rna)
E16_rna <- ScaleData(E16_rna)
E16_rna <- RunPCA(E16_rna)
E16_rna <- RunUMAP(E16_rna, dims = 1:30)

# clustering using KNN
E16_rna <- FindNeighbors(E16_rna, dims = 1:30)
E16_rna <- FindClusters(E16_rna, resolution = 0.1)
```

```{r, inlcude=FALSE}
# get annotation
library(celldex)
ref <- MouseRNAseqData() 

# annotate
library(SingleCellExperiment)
E16_rna <- JoinLayers(E16_rna)
sce <- as.SingleCellExperiment(E16_rna)

predictions <- SingleR(test = sce, ref = ref, labels = ref$label.fine)
E16_rna$cell_type <- predictions$labels
remove(sce)
```

```{r, include=FALSE}
# identify anchors
transfer.anchors <- FindTransferAnchors(reference = E16_rna,
                    query = E18_seurat,
                    reduction = 'pcaproject')


predicted.labels <- TransferData(anchorset = transfer.anchors,
             refdata = E16_rna$cell_type,
             weight.reduction = E18_seurat[['lsi']],
             dims = 2:30)
head(predicted.labels)

E18_seurat <- AddMetaData(object = E18_seurat, metadata = predicted.labels)


plot1 <- DimPlot(E18_seurat, 
        reduction = 'umap',
        group.by = 'predicted.id',
        label = F,
        repel = TRUE) + ggtitle('scATAC-Seq at E18.5 by Cell Type')

plot2 <- DimPlot(E16_rna, 
                 reduction = 'umap',
                 group.by = 'cell_type',
                 label = F,
                 repel = TRUE) + ggtitle('scRNA-Seq at E16.5')
```

From the UMAPs of the RNA and ATAC-seq data, we can see that, as expected, the vast majority of cells are NPCs. Analysis will therefore focus on this cell type.

```{r}
plot1
plot2
```

## Predict Latent Chromatic Accessibility from Gene Expression

In order to conduct this multiomics analysis, the processed datasets were integrated using the Seurat package, which was also used throughout data processing and analysis of the longitudinal RNA-seq data.

```{r, include=FALSE}
# Impute gene expression values to ATAC cells
genes.use <- VariableFeatures(E16_rna)

# Transfer gene expression data to ATAC cells
refdata <- GetAssayData(E16_rna, assay = "RNA", slot = "data")[genes.use, ]

imputation <- TransferData(
  anchorset = transfer.anchors,
  refdata = refdata,
  weight.reduction = E18_seurat[['lsi']],
  dims = 2:30
)

# Add imputed RNA data to ATAC object
E18_seurat[["imputed_RNA"]] <- imputation
```

The plots below compare gene expression levels imputed from E16.5 RNA to E18.5 chromatin data. Given these preliminary plots, correlations between gene expression and later open chromatin regions seem weak at best. This assertion is supported by the bar graph below, which illustrates the correlation for each gene's expression at E16.5 and chromatin accessibility at E18.5. However, there may be other genes in this dataset that may be more strongly associated with latent chromatin accessibility.

```{r}
# Compare gene activity (from ATAC) vs imputed gene expression (from RNA)
DefaultAssay(E18_seurat) <- "imputed_RNA"
plot_imputed <- FeaturePlot(E18_seurat, 
                            features = c('Pax6', 'Sox2', 'Nes', 'Dcx'),
                            pt.size = 0.1,
                            max.cutoff = 'q95',
                            ncol = 2) + 
  plot_annotation(title = 'Imputed Gene Expression from scRNA-seq')

DefaultAssay(E18_seurat) <- "RNA"
plot_activity <- FeaturePlot(E18_seurat, 
                             features = c('Pax6', 'Sox2', 'Dcx', 'Dlx1'),
                             pt.size = 0.1,
                             max.cutoff = 'q95',
                             ncol = 2) + 
  plot_annotation(title = 'Gene Activity from scATAC-seq')

# Side-by-side comparison
plot_imputed | plot_activity
```

```{r}
# Extract data for correlation analysis
genes_to_test <- c('Pax6', 'Sox2', 'Dcx', 'Dlx1', 'Eomes', 'Tbr1', 'Neurod1')
genes_to_test <- genes_to_test[genes_to_test %in% rownames(E18_seurat[["RNA"]])]

correlation_results <- data.frame()

for (gene in genes_to_test) {
  # Gene activity from ATAC
  activity <- E18_seurat[["RNA"]]@data[gene, ]
  
  # Imputed expression from RNA
  expression <- E18_seurat[["imputed_RNA"]]@data[gene, ]
  
  # Calculate correlation
  cor_result <- cor.test(activity, expression, method = "spearman")
  
  correlation_results <- rbind(correlation_results, data.frame(
    gene = gene,
    correlation = cor_result$estimate,
    p_value = cor_result$p.value
  ))
}

print("Correlation between Gene Activity (ATAC) and Imputed Expression (RNA):")
print(correlation_results)

# Visualize correlations
library(ggplot2)
ggplot(correlation_results, aes(x = reorder(gene, correlation), y = correlation)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  geom_text(aes(label = round(correlation, 2)), vjust = -0.5) +
  labs(title = "Gene Expression vs Chromatin Accessibility Correlation",
       x = "Gene", y = "Spearman Correlation") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

By integrating the two datasets, we can observe correlations between open chromatin regions and gene expression. I focus on Pax6, which, from previous plots, displayed enriched open chromatin regions and moderate to high gene expression. The plot below represents the different peaks of each cluster, and shows links between open chromatin regions and Pax6 expression. There are two links between the promoter region of Pax6 and Elp4. These genes are physically close together, and critically, Elp4 is known to contain elements which regulate Pax6 expression (NIH).

```{r}
# Link ATAC peaks to genes based on correlation
DefaultAssay(E18_seurat) <- "ATAC"

# This requires the imputed RNA data
library(BSgenome.Mmusculus.UCSC.mm10)
E18_seurat <- RegionStats(
  object = E18_seurat,
  genome = BSgenome.Mmusculus.UCSC.mm10
)

E18_seurat <- LinkPeaks(
  object = E18_seurat,
  peak.assay = "ATAC",
  expression.assay = "imputed_RNA",
  genes.use = genes_to_test
)

# Visualize peak-gene links
CoveragePlot(
  object = E18_seurat,
  region = "Pax6",
  features = "Pax6",
  expression.assay = "imputed_RNA",
  extend.upstream = 50000,
  extend.downstream = 50000
)
```

Finally, to elucidate any other potential Pax6 regulators, I conducted Spearman's correlation testing, testing the correlation between Pax6 gene activity at E18.5 and all other genes whose expression was recorded at E16.5. Testing did not detect any moderate or strong correlations (\|rho\| \> 0.5). The strongest statistically significant correlations (\|rho\| = [0.3, 0.32], FDR \> 0.05), did yeild some genes with established or indirect relationships with Pax6.

Cdk2 (rho = 0.32, FDR \< 0.0001) and other cell cycle regulators have been shown to be dependent on Pax6 for expression (Sansom et al., 2009). However, expression of Cdk2 here precedes Pax6 chromatin accessibility, which is not representative of Pax6 regulation on Cdk2.

Vcam1 (rho = 0.32, FDR \< 0.0001) is known to be co-expressed with Pax6 in radial glial cells in the developing cortex, and are considered markers for Radial Glial Cells (RGCs) (Hu et al., 2017).

```{r}
# identify potential predictors of Pax6 chromatin accessibility

pax6_accessibility <- E18_seurat[["RNA"]]@data["Pax6", ]

# Get all genes from imputed RNA (predictor variables)
genes_to_test <- rownames(E18_seurat[["imputed_RNA"]])

correlation_results <- data.frame()

# Loop through all genes to find which predict Pax6 accessibility
for (gene in genes_to_test) {
  # Imputed expression of each gene from E16.5 RNA
  expression <- E18_seurat[["imputed_RNA"]]@data[gene, ]
  
  # Skip genes with no variation
  if (sd(expression) == 0) next
  
  # Calculate correlation
  cor_result <- cor.test(expression, pax6_accessibility, method = "spearman")
  
  correlation_results <- rbind(correlation_results, data.frame(
    gene = gene,
    correlation = cor_result$estimate,
    p_value = cor_result$p.value
  ))
}

# Adjust p-values for multiple testing
correlation_results$p_adjusted <- p.adjust(correlation_results$p_value, method = "BH")

# Sort by absolute correlation strength
correlation_results <- correlation_results[order(abs(correlation_results$correlation), decreasing = TRUE), ]

# Display top results
cat("\nTop 20 genes whose expression correlates with Pax6 chromatin accessibility:\n")
print(head(correlation_results, 20))

# Get significant genes (adjusted p-value < 0.05)
significant_genes <- correlation_results[correlation_results$p_adjusted < 0.05, ]
cat(paste("\nNumber of significant genes (FDR < 0.05):", nrow(significant_genes), "\n"))

# Visualize top 30 correlations
top_genes <- head(correlation_results, 30)

library(ggplot2)

# Separate visualization for positive and negative correlations
pos_genes <- head(correlation_results[correlation_results$correlation > 0, ], 15)
neg_genes <- head(correlation_results[correlation_results$correlation < 0, ], 15)

p2 <- ggplot(pos_genes, aes(x = reorder(gene, correlation), y = correlation)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  geom_text(aes(label = round(correlation, 2)), hjust = -0.1, size = 3) +
  labs(title = "Top Positive Predictors of Pax6 Accessibility",
       x = "Gene", y = "Spearman Correlation") +
  coord_flip() +
  theme_minimal()

p3 <- ggplot(neg_genes, aes(x = reorder(gene, correlation), y = correlation)) +
  geom_bar(stat = "identity", fill = "coral") +
  geom_text(aes(label = round(correlation, 2)), hjust = 1.1, size = 3) +
  labs(title = "Top Negative Predictors of Pax6 Accessibility",
       x = "Gene", y = "Spearman Correlation") +
  coord_flip() +
  theme_minimal()

library(patchwork)
p2 / p3

# Scatter plots for top predictors
top_5_genes <- head(correlation_results, 5)$gene

scatter_plots <- list()
for (i in 1:min(5, length(top_5_genes))) {
  gene <- top_5_genes[i]
  plot_data <- data.frame(
    expression = E18_seurat[["imputed_RNA"]]@data[gene, ],
    accessibility = pax6_accessibility,
    cell_type = E18_seurat$predicted.id
  )
  
  p <- ggplot(plot_data, aes(x = expression, y = accessibility, color = cell_type)) +
    geom_point(alpha = 0.5, size = 1) +
    geom_smooth(method = "lm", se = TRUE, color = "black", linetype = "dashed") +
    labs(title = paste(gene, "â†’ Pax6 Accessibility"),
         x = paste(gene, "Expression (E16.5)"),
         y = "Pax6 Accessibility (E18.5)") +
    theme_minimal() +
    theme(legend.position = "none")
  
  scatter_plots[[i]] <- p
}

# Arrange scatter plots
wrap_plots(scatter_plots, ncol = 2)

```

This analysis demonstrates some of the transcriptional changes taking place during cortical neurogenesis, and the epigenetic landscape that follows. Future analysis could integrate the scATAC seq data and scRNA data to create a directional gene network, using packages such as CellOracle, to predict and uncover direct and indirect gene to gene relationships, and identify the unique networks contributing to the vascular and brain circuitry development that occurs parallel to layer formation, as was indicated by some of the genes identified in this analysis.

# MapMyCells

MapMyCells is a useful tool that can be applied to longitudinal single cell data to understand the change in cell type distributions across time. Although we previously used an automated annotation technique using the packages celldex and SingleR, MapMyCells is a useful addition to this analysis, as it predicts specific neuron types, including the neurotransmitter to which they respond and the location of the neuron.

Most (49%) of cells following pre-processing have been mapped to immature GABA-ergic olfactory bulb neurons. 26.88% of cells are mapped to Dentate Gryus immature glutamatergic neurons. Some neurons were mapped to locations not on the forebrain. Three were mapped to the pons, 10 mapped to the midbrain, one mapped to the medulla, and one mapped to the cerebellum. These cells account for about 0.05% of the data.

```{r}
map_cells <- read.csv("merged_data_10xWholeMouseBrain(CCN20230722)_HierarchicalMapping_UTC_1763661837087/merged_data_10xWholeMouseBrain(CCN20230722)_HierarchicalMapping_UTC_1763661837087.csv", 
                      row.names = 1,
                      skip = 4)
map_cells$time.point <- substr(rownames(map_cells), 1, 5)
```

```{r}
library(Seurat)
# add MapMyCells annotations to Seurat object
# match cell names 
common_cells <- intersect(rownames(map_cells), colnames(combined))

combined$predicted_class_type <- map_cells[colnames(combined), "class_name"]
combined$prediction_class_score <- map_cells[colnames(combined), "class_bootstrapping_probability"]

combined$predicted_subclass_type <- map_cells[colnames(combined), "subclass_name"]
combined$prediction_subclass_score <- map_cells[colnames(combined), "subclass_bootstrapping_probability"]

combined$predicted_supertype_type <- map_cells[colnames(combined), "supertype_name"]
combined$prediction_supertype_score <- map_cells[colnames(combined), "supertype_bootstrapping_probability"]

combined$predicted_cluster_type <- map_cells[colnames(combined), "cluster_name"]
combined$prediction_cluster_score <- map_cells[colnames(combined), "cluster_bootstrapping_probability"]
```

From the UMAP plot below we can see some clustering by the main predicted classes; immature olfactory bulb GABA-ergic neurons and immature dentate gyrus glutamatergic neurons. We can also observe how clustering differs by cell type at each time point. Although there are three distinct GABA-ergic clusters, one cluster appears earlier in development. However, the transcriptional differences between is unclear.

We can use the bootstrapping probability, which is the proportion of votes that were in favor of the assignment the cell was mapped to, as a QC metric, to see if confidence also follows a pattern in our data. Interestingly, the clusters that have the highest bootstrapping probabilities are clusters of cells that were collected at the earliest time points. Unsurprisingly, the areas with the lowest scores are where cells with differing assignments overlap.

```{r}
# Visualize class types on UMAP
DimPlot(combined, group.by = "predicted_class_type", label = F, repel = TRUE) +
    ggplot2::ggtitle("MapMyCells Cell Type Annotations")
```

```{r}
# Compare across samples/timepoints
DimPlot(combined, group.by = "predicted_class_type", split.by = "orig.ident")
```

```{r}
# Visualize prediction confidence
FeaturePlot(combined, features = "prediction_class_score") +
  ggplot2::scale_color_viridis_c() +
  ggplot2::ggtitle("Prediction Confidence Scores")
```

Investigating the two classes to which the majority of cells were mapped provides further insight to the transcriptomic data. Below are UMAP plots of these cells by subclasses. We can see that again these cells are mostly characterized as immature neurons, which aligns with previous results and the experiment context. We can see that the two GABA-ergic clusters that formed later than the other GABA-ergic cluster differ from the first cluster by supertype. According to Velthoven et al., (2024), both of these supertypes (166 and 168), along with 171 and 172, characterize the most immature neurons in their subclass "...based on gene expression, spatial location and pseudo-temporal ordering." These results suggest that, although supertype 166 and 168 are similar, the time in which they develop may be a main discriminant.

```{r}
main_classes <- c("04 DG-IMN Glut", "05 OB-IMN GABA")
combined_filtered <- subset(combined, 
                            cells = colnames(combined)[combined$predicted_class_type %in% main_classes])
```

```{r}
DimPlot(combined_filtered, group.by = "predicted_subclass_type", label = F, repel = TRUE) +
    ggplot2::ggtitle("MapMyCells Subclass Annotations of DG Glut and OB GABA Classes")
DimPlot(combined_filtered, group.by = "predicted_supertype_type", label = F, repel = TRUE) +
    ggplot2::ggtitle("MapMyCells Supertype Annotations of DG Glut and OB GABA Classes")
```

We can further investigate the transcriptional differences between GABA-ergic supertypes 166 and 168. Below is a heat map identifying the difference in these supertypes. The heat map below shows the top 20 genes differentially expressed in supertypes 166 versus 168. Hes1 is associated with a greater expression in 166 compared to 168. Hes1 (average Log2FC = 6.83, FDR \< 0.0001) is critical for maintaining neural stem cells and timing, so it is unsurprising that Hes1 appears as a top DEG here (Dhanesh & Subahini, 2016). Tk1 (average Log2FC = 6.14, FDR \< 0.0001), also more expressed in the 166 supertype than 168, is involved in cell proliferation. Shtn1 (average Log2FC = 6.12, FDR \< 0.0001), a top DEG associated with decreased expression in 166 compared to 186, is involved in positive regulation of neuron migration and axon development.

```{r, include = F}
Idents(combined_filtered) <- "predicted_supertype_type"
combined_filtered <- JoinLayers(combined_filtered)
```

```{r, include = F}
markers_166_vs_168 <- FindMarkers(combined_filtered, 
                              ident.1 = "0166 OB-STR-CTX Inh IMN_1",
                              ident.2 = "0168 OB-STR-CTX Inh IMN_3",
                              min.pct = 0.25)
```

```{r}
# Look at top markers
library(dplyr)
markers_166_vs_168 <- markers_166_vs_168 %>% 
  dplyr::filter(p_val_adj < 0.05) %>% 
  arrange(desc(abs(avg_log2FC)))
```

```{r}
# Get top markers for each cluster
top_markers_66 <- markers_166_vs_168 %>%
  dplyr::filter(avg_log2FC > 0, p_val_adj < 0.05) %>%
  arrange(desc(avg_log2FC)) %>%
  head(10)

top_markers_68 <- markers_166_vs_168 %>%
  dplyr::filter(avg_log2FC < 0, p_val_adj < 0.05) %>%
  arrange(avg_log2FC) %>%
  head(10)

all_markers <- c(rownames(top_markers_66), rownames(top_markers_68))

# Subset to just these two clusters
combined_subset <- subset(combined, 
                          cells = colnames(combined)[combined$predicted_supertype_type %in% 
                                                     c("0166 OB-STR-CTX Inh IMN_1", 
                                                       "0168 OB-STR-CTX Inh IMN_3")])

# Set identity
Idents(combined_subset) <- "predicted_suptertype_type"

# Make heatmap
DoHeatmap(combined_subset, 
          features = all_markers,
          group.by = "predicted_supertype_type") +
  ggplot2::scale_fill_gradientn(colors = c("blue", "white", "red")) +
  ggplot2::labs(title = "Top Markers: 166 vs 168")
```

This analysis provides a broad overview of transcriptional and epigenomic changes underlying embryonic cortical development. Coupled with the MapMyCells tool, we are able to obtain a high-resolution view of neurogenesis and identify transcriptional differences between neurons at the temporal and functional level.

# References

Brown N, Alkhayer K, Clements R, Singhal N, Gregory R, Azzam S, Li S, Freeman E, McDonough J. Neuronal Hemoglobin Expression and Its Relevance to Multiple Sclerosis Neuropathology. J Mol Neurosci. 2016 May;59(1):1-17. doi: 10.1007/s12031-015-0711-6. Epub 2016 Jan 25. PMID: 26809286; PMCID: PMC4851882.

Dataset: Daniela DiBella, Kwanho Kim, Paola Arlotta, Sara Sime, Vy Vuong. (2021) Single cell transcriptomic and epigenomic profile of the developing mouse cortex: Single cell 10x ATAC-seq. [Dataset] Available from: <https://assets.nemoarchive.org/dat-35p4oe3>

Dhanesh SB, Subashini C, James J. Hes1: the maestro in neurogenesis. Cell Mol Life Sci. 2016 Nov;73(21):4019-42. doi: 10.1007/s00018-016-2277-z. Epub 2016 May 27. PMID: 27233500; PMCID: PMC11108451.

DiBella DJ, Habibi E, Stickels RR, Scalia G, Brown J, Yadollahpour P, Yang SM, Abbate C, Biancalani T, Macosko EZ, Chen F, Regev A, Arlotta P. Molecular logic of cellular diversification in the mouse cerebral cortex. Nature. 2021 Jul;595(7868):554-559. doi: 10.1038/s41586-021-03670-5. Epub 2021 Jun 23. Erratum in: Nature. 2021 Aug;596(7873):E11. doi: 10.1038/s41586-021-03797-5. PMID: 34163074; PMCID: PMC9006333.

Hu, X.-L., Chen, G., Zhang, S., Zheng, J., Wu, J., Bai, Q.-R., Wang, Y., Li, J., Wang, H., Feng, H., Li, J., Sun, X., Xia, Q., Yang, F., Hang, J., Qi, C., Phoenix, T. N., Temple, S., & Shen, Q. (2017). Persistent expression of VCAM1 in radial glial cells is required for the embryonic origin of postnatal neural stem cells.*Neuron*,*95*(2). <https://doi.org/10.1016/j.neuron.2017.06.047>

Levers TE, Edgar JM, Price DJ. The fates of cells generated at the end of neurogenesis in developing mouse cortex. J Neurobiol. 2001 Sep 15;48(4):265-77. doi: 10.1002/neu.1056. PMID: 11500840.

MapMyCells (RRID:SCR_024672)

Ohte N, Kimura T, Sekine R, Yoshizawa S, Furusho Y, Sato D, Nishiyama C, Hanashima C. Differential neurogenic patterns underlie the formation of primary and secondary areas in the developing somatosensory cortex. Cereb Cortex. 2025 Feb 5;35(2):bhae491. doi: 10.1093/cercor/bhae491. PMID: 39756431; PMCID: PMC11795310.

Richter F, Meurers BH, Zhu C, Medvedeva VP, Chesselet MF. Neurons express hemoglobin alpha- and beta-chains in rat and human brains. J Comp Neurol. 2009 Aug 10;515(5):538-47. doi: 10.1002/cne.22062. PMID: 19479992; PMCID: PMC3123135.

Sansom SN, Griffiths DS, Faedo A, Kleinjan DJ, Ruan Y, Smith J, van Heyningen V, Rubenstein JL, Livesey FJ. The level of the transcription factor Pax6 is essential for controlling the balance between neural stem cell self-renewal and neurogenesis. PLoS Genet. 2009 Jun;5(6):e1000511. doi: 10.1371/journal.pgen.1000511. Epub 2009 Jun 12. PMID: 19521500; PMCID: PMC2686252.

van Velthoven CTJ, Gao Y, Kunst M, Lee C, McMillen D, Chakka AB, Casper T, Clark M, Chakrabarty R, Daniel S, Dolbeare T, Ferrer R, Gloe J, Goldy J, Guzman J, Halterman C, Ho W, Huang M, James K, Nguy B, Pham T, Ronellenfitch K, Thomas ED, Torkelson A, Pagan CM, Kruse L, Dee N, Ng L, Waters J, Smith KA, Tasic B, Yao Z, Zeng H. The transcriptomic and spatial organization of telencephalic GABAergic neuronal types. bioRxiv [Preprint]. 2024 Jun 18:2024.06.18.599583. doi: 10.1101/2024.06.18.599583. Update in: Nature. 2025 Nov;647(8088):143-156. doi: 10.1038/s41586-025-09296-1. PMID: 38948843; PMCID: PMC11212977.
